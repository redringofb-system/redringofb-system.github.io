'use strict';const smPushApplicationServerPublicKey="BBSA0DccGlCRL_gZzCUHr_Gb60nh4rNXfTK_dWv8qS4gfVzSEjbZKPI_aLMCfd1Jz57F-l0xYoSIgWcrCSPBc7k=",smPushSiteId="75dn34omek",smClientId="l3e4o1jdvy",serviceWorker="/service-worker.js";let smPushDomain="push.trk-consulatu.com",pushLogging=!0;const version=815;let smPushSubscriptionId,subscriptionDomain="subscription.trk-consulatu.com",eventDomain="event.trk-consulatu.com",sessionId="";const utmObj={mt:"",utm_source:"",utm_medium:"",utm_campaign:"",source_one:"",source_two:"",source_three:"",source_four:"",source_five:""};function urlBase64ToUint8Array(a){const b="=".repeat((4-a.length%4)%4),c=(a+b).replace(/\-/g,"+").replace(/_/g,"/"),d=window.atob(c),e=new Uint8Array(d.length);for(let b=0;b<d.length;++b)e[b]=d.charCodeAt(b);return e}function pullUrlParams(a){let b=getUrlVars();a.timezone=new Intl.DateTimeFormat().resolvedOptions().timeZone,a.mediaId=setIfNull(utmObj.mt,b.mt),a.utmSource=setIfNull(utmObj.utm_source,b.utm_source),a.utmMedium=setIfNull(utmObj.utm_medium,b.utm_medium),a.utmMedium=setIfNull(a.utmMedium,b.source_one),a.utmCampaign=setIfNull(utmObj.utm_campaign,b.utm_campaign),a.sourceOne=setIfNull(utmObj.source_one,b.source_one),a.sourceTwo=setIfNull(utmObj.source_two,b.source_two),a.sourceThree=setIfNull(utmObj.source_three,b.source_three),a.sourceFour=setIfNull(utmObj.source_four,b.source_four),a.sourceFive=setIfNull(utmObj.source_five,b.source_five),a.sourceOne=setIfNull(a.sourceOne,b.s1),a.sourceTwo=setIfNull(a.sourceTwo,b.s2),a.sourceThree=setIfNull(a.sourceThree,b.s3),a.sourceFour=setIfNull(a.sourceFour,b.s4),a.sourceFour=setIfNull(a.sourceFour,b.keywords),a.sourceFour=setIfNull(a.sourceFour,b.keyword),a.sourceFour=setIfNull(a.sourceFour,b.ky),a.sourceFive=setIfNull(a.sourceFive,b.s5),a.email=b.email,a.firstName=b.firstName,a.firstName=setIfNull(a.firstName,b.fname),a.lastName=b.lastName,a.lastName=setIfNull(a.lastName,b.lname),a.offerId=b.offer_id,a.sessionId=setIfNull(setIfNull(getSessionId(),b.session_id),""),a.version=version,a.psid=b.psid,a.oai=b.oai}function push_subscribe(){navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription().then(async function(b){if(!b&&"denied"!==Notification.permission){const b=urlBase64ToUint8Array(smPushApplicationServerPublicKey);return logPushEvent("subscribe_prompt","subscribe_prompt",version),a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:b})}"denied"===Notification.permission&&logPushEvent("denied_impression","denied_impression",version)}).catch(function(a){console.error("Service Worker Error",a),"Registration failed - permission denied"===a.message?"default"===Notification.permission?logPushEvent("closed_prompt",a.toString(),version):logPushEvent("blocked",a.toString(),version):logPushEvent("other_error",a.toString(),version)})}).then(function(a){if(a){let b=a.toJSON();pullUrlParams(b);let c={name:"pushUtm"};c.value={utmSource:b.utmSource,utmMedium:b.utmMedium,utmCampaign:b.utmCampaign},fetch("https://"+subscriptionDomain+"/register/push/"+smPushSiteId,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(b)}).then(function(a){if(a.ok){let b=a.json();return b}}).then(function(a){console.log("subscribed!"),smPushSubscriptionId=a.id,getStore(function(a){let b={name:"pushSubscriptionId"};b.value=smPushSubscriptionId,smPushSubscriptionId&&a.put(b),a.put(c)})}).catch(function(a){console.error("Service Worker Error",a),pushLogging&&logPushEvent("error_subscribing",a,version)})}})}function push_subscribe_promise(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription().then(function(b){if(!b){const b=urlBase64ToUint8Array(smPushApplicationServerPublicKey);return a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:b})}}).catch(function(a){console.error("Service Worker Error",a),pushLogging&&"Registration failed - permission denied"===a.message?logPushEvent("blocked",a.toString(),version):logPushEvent("other_error",a.toString(),version)})}).then(function(a){if(a){const b=a.toJSON();return pullUrlParams(b),b}}).then(a=>{return fetch("https://"+subscriptionDomain+"/register/push/"+smPushSiteId,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(a)})}).then(function(a){if(a.ok)return a.json()}).then(function(a){console.log("subscribed!"),smPushSubscriptionId=a.id;let b={name:"pushUtm"};b.value={utmSource:a.utmSource,utmMedium:a.utmMedium,utmCampaign:a.utmCampaign},getStore(function(a){let c={name:"pushSubscriptionId"};c.value=smPushSubscriptionId,smPushSubscriptionId&&a.put(c),a.put(b)})}).catch(function(a){console.error("Service Worker Error",a),pushLogging&&logPushEvent("error_subscribing",a,version)})}function setIfNull(c,a){return void 0===c||null===c||""===c?a:c}function logPushEvent(a,b,c){let d=JSON.stringify(b);"{}"!==d&&(b=d);let e={};pullUrlParams(e),e.message=b,e.version=c,e.event="p_"+a;fetch("https://"+eventDomain+"/register/event_log/"+smPushSiteId,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(e)}).catch(function(a){console.error("Log Error, error ",a)})}function push_unsubscribe(){navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){return a.unsubscribe().then(function(){console.log("Unsubscribed",a.endpoint);return fetch("https://"+subscriptionDomain+"/register/unsubscribe/"+smPushSiteId,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify(a)})})})}function push_init(){"serviceWorker"in navigator&&"PushManager"in window?(pushLogging&&console.log("Service Worker and Push is supported"),navigator.serviceWorker.register(serviceWorker).then(function(a){pushLogging&&console.log("Service Worker is registered",a)}).catch(function(a){console.error("Service Worker Error",a),pushLogging&&"https:"===location.protocol&&logPushEvent("sw_register_error",location.href+" error:"+a,version)})):(console.warn("Push messaging is not supported"),logPushEvent("not_supported","not_supported",version))}function setSessionId(a){"serviceWorker"in navigator&&"PushManager"in window&&(sessionId=a)}function setUtm(a){"serviceWorker"in navigator&&"PushManager"in window&&null!=a&&Object.assign(utmObj,a)}function getSessionId(){return sessionId}function getUrlVars(){let a={},b=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=d});return a}function getDomainName(a){return a.substring(a.lastIndexOf(".",a.lastIndexOf(".")-1)+1)}function getStore(a){if(self.indexedDB){let b=self.indexedDB.open("pushPlatFormDb",2);b.onerror=function(){console.log("error db"+b.error),a(null)},b.onsuccess=function(){let c=b.result,d=c.transaction(["store"],"readwrite"),e=d.objectStore("store");a(e)},b.onupgradeneeded=function(a){console.log("upgrading db from version "+a.oldVersion+" to 2");let c=b.result;if(2>a.oldVersion){c.createObjectStore("store",{keyPath:"name"})}}}else a(null)}
